<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>crrlpy.crrls &mdash; CRRLpy 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/sphinx_paramlinks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="CRRLpy 0.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">CRRLpy 0.1 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for crrlpy.crrls</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">collections</span>

<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">mpl</span>
<span class="n">havedisplay</span> <span class="o">=</span> <span class="s">&quot;DISPLAY&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">havedisplay</span><span class="p">:</span>
    <span class="n">mpl</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">&#39;Agg&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.integrate</span> <span class="kn">as</span> <span class="nn">sint</span>

<span class="kn">from</span> <span class="nn">astropy.constants</span> <span class="kn">import</span> <span class="n">k_B</span>
<span class="kn">from</span> <span class="nn">lmfit</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">lmfit.models</span> <span class="kn">import</span> <span class="n">VoigtModel</span><span class="p">,</span> <span class="n">ConstantModel</span><span class="p">,</span> <span class="n">GaussianModel</span><span class="p">,</span> <span class="n">PolynomialModel</span><span class="p">,</span> <span class="n">PowerLawModel</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">wofz</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">from</span> <span class="nn">scipy.constants</span> <span class="kn">import</span> <span class="n">c</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">wiener</span><span class="c">#, savgol_filter</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage.filters</span> <span class="kn">import</span> <span class="n">gaussian_filter</span>
<span class="kn">from</span> <span class="nn">frec_calc</span> <span class="kn">import</span> <span class="n">set_dn</span><span class="p">,</span> <span class="n">make_line_list</span>

<div class="viewcode-block" id="alphanum_key"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.alphanum_key">[docs]</a><span class="k">def</span> <span class="nf">alphanum_key</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Turn a string into a list of string and number chunks.</span>
<span class="sd">        &quot;z23a&quot; -&gt; [&quot;z&quot;, 23, &quot;a&quot;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span> <span class="n">tryint</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;([0-9]+)&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="p">]</span>
</div>
<div class="viewcode-block" id="average"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.average">[docs]</a><span class="k">def</span> <span class="nf">average</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Averages data along the given axis by combining</span>
<span class="sd">    n adjacent values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Will not work&quot;</span>
        <span class="n">avg_tmp</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">avg_tmp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">si</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span>
            <span class="k">if</span> <span class="n">si</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">avg_tmp</span> <span class="o">+=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">n</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">avg_tmp</span> <span class="o">+=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="o">-</span><span class="n">si</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
        <span class="n">avg_tmp</span> <span class="o">=</span> <span class="n">avg_tmp</span><span class="o">/</span><span class="n">n</span>
        
        <span class="k">return</span> <span class="n">avg_tmp</span>
            <span class="c">#avg4_temp = (temp[0:-3:4] + temp[1:-2:4] + temp[2:-1:4] + temp[3::4])/4.</span>
</div>
<div class="viewcode-block" id="best_match_indx"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.best_match_indx">[docs]</a><span class="k">def</span> <span class="nf">best_match_indx</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Searchs for the best match to a value inside an array given a tolerance.</span>
<span class="sd">    @param value - value to find inside the array</span>
<span class="sd">    @type value - float</span>
<span class="sd">    @param tol - tolerance for match</span>
<span class="sd">    @type tol - float</span>
<span class="sd">    @param array - list to search for the given value</span>
<span class="sd">    @type array - numpy.array</span>
<span class="sd">    @return - best match for val inside array</span>
<span class="sd">    @rtype - float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">upp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">array</span> <span class="o">&gt;=</span> <span class="n">value</span> <span class="o">-</span> <span class="n">tol</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">array</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">+</span> <span class="n">tol</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">upp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">low</span><span class="p">)):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">upp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">low</span><span class="p">))</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">low</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">low</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">upp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    </div>
<div class="viewcode-block" id="best_match_indx2"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.best_match_indx2">[docs]</a><span class="k">def</span> <span class="nf">best_match_indx2</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
    <span class="n">subarr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">array</span> <span class="o">-</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">subarrmin</span> <span class="o">=</span> <span class="n">subarr</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">subarr</span> <span class="o">==</span> <span class="n">subarrmin</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="best_match_value"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.best_match_value">[docs]</a><span class="k">def</span> <span class="nf">best_match_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
    <span class="n">subarr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">array</span> <span class="o">-</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">subarrmin</span> <span class="o">=</span> <span class="n">subarr</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">array</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">subarr</span> <span class="o">==</span> <span class="n">subarrmin</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
    </div>
<div class="viewcode-block" id="blank_lines"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.blank_lines">[docs]</a><span class="k">def</span> <span class="nf">blank_lines</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">reffreqs</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">dv0</span><span class="p">):</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">reffreqs</span><span class="p">:</span>
            <span class="c">#print &quot;#freq: {0} #tau: {1}&quot;.format(len(freq), len(tau))</span>
            <span class="n">lm0</span><span class="p">,</span> <span class="n">lmf</span> <span class="o">=</span> <span class="n">get_line_mask</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">dv0</span><span class="p">)</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">freq</span><span class="p">[:</span><span class="n">lm0</span><span class="p">],</span> <span class="n">freq</span><span class="p">[</span><span class="n">lmf</span><span class="p">:]))</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">tau</span><span class="p">[:</span><span class="n">lm0</span><span class="p">],</span> <span class="n">tau</span><span class="p">[</span><span class="n">lmf</span><span class="p">:]))</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">lm0</span><span class="p">,</span> <span class="n">lmf</span> <span class="o">=</span> <span class="n">get_line_mask</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">reffreqs</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">dv0</span><span class="p">)</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">freq</span><span class="p">[:</span><span class="n">lm0</span><span class="p">],</span> <span class="n">freq</span><span class="p">[</span><span class="n">lmf</span><span class="p">:]))</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">tau</span><span class="p">[:</span><span class="n">lm0</span><span class="p">],</span> <span class="n">tau</span><span class="p">[</span><span class="n">lmf</span><span class="p">:]))</span>
        
    <span class="k">return</span> <span class="n">freq</span><span class="p">,</span> <span class="n">tau</span>
</div>
<div class="viewcode-block" id="blank_lines2"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.blank_lines2">[docs]</a><span class="k">def</span> <span class="nf">blank_lines2</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">reffreqs</span><span class="p">,</span> <span class="n">dv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">reffreqs</span><span class="p">:</span>
            <span class="c">#print &quot;#freq: {0} #tau: {1}&quot;.format(len(freq), len(tau))</span>
            <span class="n">lm0</span><span class="p">,</span> <span class="n">lmf</span> <span class="o">=</span> <span class="n">get_line_mask2</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">dv</span><span class="p">)</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">freq</span><span class="p">[:</span><span class="n">lm0</span><span class="p">],</span> <span class="n">freq</span><span class="p">[</span><span class="n">lmf</span><span class="p">:]))</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">tau</span><span class="p">[:</span><span class="n">lm0</span><span class="p">],</span> <span class="n">tau</span><span class="p">[</span><span class="n">lmf</span><span class="p">:]))</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">lm0</span><span class="p">,</span> <span class="n">lmf</span> <span class="o">=</span> <span class="n">get_line_mask2</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">reffreqs</span><span class="p">,</span> <span class="n">dv</span><span class="p">)</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">freq</span><span class="p">[:</span><span class="n">lm0</span><span class="p">],</span> <span class="n">freq</span><span class="p">[</span><span class="n">lmf</span><span class="p">:]))</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">tau</span><span class="p">[:</span><span class="n">lm0</span><span class="p">],</span> <span class="n">tau</span><span class="p">[</span><span class="n">lmf</span><span class="p">:]))</span>
        
    <span class="k">return</span> <span class="n">freq</span><span class="p">,</span> <span class="n">tau</span>
</div>
<div class="viewcode-block" id="df2dv"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.df2dv">[docs]</a><span class="k">def</span> <span class="nf">df2dv</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a frequency delta</span>
<span class="sd">    to a velocity delta given</span>
<span class="sd">    a central frequency.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">df</span><span class="o">/</span><span class="n">f0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="dv2df"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.dv2df">[docs]</a><span class="k">def</span> <span class="nf">dv2df</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="n">dv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a velocity delta</span>
<span class="sd">    to a frequeny delta given</span>
<span class="sd">    a central frequency.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">dv</span><span class="o">*</span><span class="n">f0</span><span class="o">/</span><span class="n">c</span>
</div>
<div class="viewcode-block" id="dv_minus_doppler"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.dv_minus_doppler">[docs]</a><span class="k">def</span> <span class="nf">dv_minus_doppler</span><span class="p">(</span><span class="n">dV</span><span class="p">,</span> <span class="n">ddV</span><span class="p">,</span> <span class="n">dD</span><span class="p">,</span> <span class="n">ddD</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the Lorentzian contribution to the </span>
<span class="sd">    line width assuming that the line has a Voigt </span>
<span class="sd">    profile.</span>
<span class="sd">    dV (float) Total line width.</span>
<span class="sd">    ddV (float) Uncertainty in the total line width.</span>
<span class="sd">    dD (float) Doppler contribution to the line width.</span>
<span class="sd">    ddD (float) Uncertainty in the Doppler contribution to the line width.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.5346</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">0.2166</span>
    
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dV</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">4.</span><span class="o">*</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dD</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dV</span><span class="p">,</span> <span class="mf">2.</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;No real solutions, check input.&quot;</span>
        <span class="k">return</span> <span class="mi">0</span>
    
    <span class="n">dL_p</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dV</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">))</span>
    <span class="n">dL_m</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dV</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">dL_m</span> <span class="o">&lt;</span> <span class="n">dV</span><span class="p">:</span>
        <span class="n">dL</span> <span class="o">=</span> <span class="n">dL_m</span>
        <span class="n">ddL1</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">a</span> <span class="o">-</span> <span class="p">((</span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dV</span><span class="p">)</span> <span class="o">+</span> <span class="mf">8.</span><span class="o">*</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">dV</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dV</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">-</span> <span class="mf">4.</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dD</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dV</span><span class="p">,</span> <span class="mf">2.</span><span class="p">))))</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dL</span> <span class="o">=</span> <span class="n">dL_p</span>
        <span class="n">ddL1</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="p">((</span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dV</span><span class="p">)</span> <span class="o">+</span> <span class="mf">8.</span><span class="o">*</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">dV</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dV</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">-</span> <span class="mf">4.</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dD</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dV</span><span class="p">,</span> <span class="mf">2.</span><span class="p">))))</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">))</span>
        
    <span class="n">ddL2</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">*</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">dD</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dV</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">-</span> <span class="mf">4.</span><span class="o">*</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dD</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dV</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)))</span>
    
    <span class="n">ddL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">ddL1</span><span class="o">*</span><span class="n">ddV</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">ddL2</span><span class="o">*</span><span class="n">ddV</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> 
    
    <span class="k">return</span> <span class="n">dL</span><span class="p">,</span> <span class="n">ddL</span>
</div>
<div class="viewcode-block" id="dv_minus_doppler2"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.dv_minus_doppler2">[docs]</a><span class="k">def</span> <span class="nf">dv_minus_doppler2</span><span class="p">(</span><span class="n">dV</span><span class="p">,</span> <span class="n">ddV</span><span class="p">,</span> <span class="n">dD</span><span class="p">,</span> <span class="n">ddD</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the Lorentzian contribution to the </span>
<span class="sd">    line width assuming that the line has a Voigt </span>
<span class="sd">    profile.</span>
<span class="sd">    dV (float) Total line width.</span>
<span class="sd">    ddV (float) Uncertainty in the total line width.</span>
<span class="sd">    dD (float) Doppler contribution to the line width.</span>
<span class="sd">    ddD (float) Uncertainty in the Doppler contribution to the line width.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.5346</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">0.2166</span>
    
    <span class="n">den</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">dif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dV</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dD</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">dV</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">den</span><span class="o">*</span><span class="n">dif</span>
    
    <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;No real solutions, check input.&quot;</span>
        <span class="k">return</span> <span class="mi">0</span>
    
    <span class="n">dL_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">dV</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">))</span><span class="o">/</span><span class="n">den</span>
    <span class="n">dL_m</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">dV</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">))</span><span class="o">/</span><span class="n">den</span>
    
    <span class="k">if</span> <span class="n">dL_m</span> <span class="o">&lt;</span> <span class="n">dV</span><span class="p">:</span>
        <span class="n">dL</span> <span class="o">=</span> <span class="n">dL_m</span>
        <span class="n">ddL1</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dV</span> <span class="o">-</span> <span class="n">dV</span><span class="o">*</span><span class="n">den</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">dV</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">den</span><span class="o">*</span><span class="n">dif</span><span class="p">))</span><span class="o">/</span><span class="n">den</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dL</span> <span class="o">=</span> <span class="n">dL_p</span>
        <span class="n">ddL1</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">dV</span> <span class="o">-</span> <span class="n">dV</span><span class="o">*</span><span class="n">den</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">dV</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">den</span><span class="o">*</span><span class="n">dif</span><span class="p">))</span><span class="o">/</span><span class="n">den</span>
        
    <span class="n">ddL2</span> <span class="o">=</span> <span class="n">dD</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">dV</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">den</span><span class="o">*</span><span class="n">dif</span><span class="p">)</span>
    
    <span class="n">ddL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">ddL1</span><span class="o">*</span><span class="n">ddV</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">ddL2</span><span class="o">*</span><span class="n">ddV</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> 
    
    <span class="k">return</span> <span class="n">dL</span><span class="p">,</span> <span class="n">ddL</span>
</div>
<div class="viewcode-block" id="f2n"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.f2n">[docs]</a><span class="k">def</span> <span class="nf">f2n</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">n_max</span><span class="o">=</span><span class="mi">1500</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comverts a given frequency to a principal quantum </span>
<span class="sd">    number n of a given transition and atomic specie.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">line</span><span class="p">,</span> <span class="n">nn</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">make_line_list</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">n_max</span><span class="o">=</span><span class="n">n_max</span><span class="p">)</span>
    <span class="n">fii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">nn</span><span class="p">[</span><span class="n">fii</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="find_lines_in_band"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.find_lines_in_band">[docs]</a><span class="k">def</span> <span class="nf">find_lines_in_band</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="s">&#39;CI&#39;</span><span class="p">,</span> <span class="n">transition</span><span class="o">=</span><span class="s">&#39;alpha&#39;</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds if there are any lines corresponding to </span>
<span class="sd">    transitions of the given species in the frequency range.</span>
<span class="sd">    The line transition frequencies are corrected for redshift.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c"># Load the reference frequencies</span>
    <span class="n">qn</span><span class="p">,</span> <span class="n">restfreq</span> <span class="o">=</span> <span class="n">load_ref</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">transition</span><span class="p">)</span>
    
    <span class="c"># Correct rest frequencies for redshift</span>
    <span class="n">reffreq</span> <span class="o">=</span> <span class="n">restfreq</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span>
    
    <span class="c"># Check which lines lie within the subband</span>
    <span class="n">mask_ref</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">reffreq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">reffreq</span><span class="p">)</span>
    <span class="n">reffreqs</span> <span class="o">=</span> <span class="n">reffreq</span><span class="p">[</span><span class="n">mask_ref</span><span class="p">]</span>
    <span class="n">refqns</span> <span class="o">=</span> <span class="n">qn</span><span class="p">[</span><span class="n">mask_ref</span><span class="p">]</span>
    
    <span class="n">nlin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reffreqs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Found {0} {1} lines within the subband.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nlin</span><span class="p">,</span> <span class="n">transition</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nlin</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Corresponding to n values: {0}--{1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">refqns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">refqns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">nlin</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Corresponding to n value {0} and frequency {1} MHz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">refqns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reffreqs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">refqns</span><span class="p">,</span> <span class="n">reffreqs</span>
</div>
<div class="viewcode-block" id="find_lines_sb"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.find_lines_sb">[docs]</a><span class="k">def</span> <span class="nf">find_lines_sb</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">transition</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds if there are any lines corresponding to </span>
<span class="sd">    transitions of the given species in the frequency range.</span>
<span class="sd">    The line transition frequencies are corrected for redshift.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c"># Load the reference frequencies</span>
    <span class="n">qn</span><span class="p">,</span> <span class="n">restfreq</span> <span class="o">=</span> <span class="n">load_ref2</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>
    
    <span class="c"># Correct rest frequencies for redshift</span>
    <span class="n">reffreq</span> <span class="o">=</span> <span class="n">restfreq</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span>
    
    <span class="c"># Check which lines lie within the subband</span>
    <span class="n">mask_ref</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">reffreq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">reffreq</span><span class="p">)</span>
    <span class="n">reffreqs</span> <span class="o">=</span> <span class="n">reffreq</span><span class="p">[</span><span class="n">mask_ref</span><span class="p">]</span>
    <span class="n">refqns</span> <span class="o">=</span> <span class="n">qn</span><span class="p">[</span><span class="n">mask_ref</span><span class="p">]</span>
    
    <span class="n">nlin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reffreqs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Found {0} {1} lines within the subband.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nlin</span><span class="p">,</span> <span class="n">transition</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nlin</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Corresponding to n values: {0}--{1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">refqns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">refqns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">nlin</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Corresponding to n value {0} and frequency {1} MHz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">refqns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reffreqs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">refqns</span><span class="p">,</span> <span class="n">reffreqs</span>
</div>
<div class="viewcode-block" id="fit_continuum"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.fit_continuum">[docs]</a><span class="k">def</span> <span class="nf">fit_continuum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">degree</span><span class="p">,</span> <span class="n">p0</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Divide tb by given a model</span>
<span class="sd">    and starting parameters p0.</span>
<span class="sd">    Returns: tb/model - 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Divide by linear baseline</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">PolynomialModel</span><span class="p">(</span><span class="n">degree</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">make_params</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;Insuficient starting parameter values.&quot;</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">p0</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>

    <span class="n">fit</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fit</span>
</div>
<div class="viewcode-block" id="fit_line"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.fit_line">[docs]</a><span class="k">def</span> <span class="nf">fit_line</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">rms</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    
    <span class="c"># Set the model used to fit the line</span>
    <span class="c">#mod, nparams = set_fit_model(model)</span>
    
    <span class="c"># Set up dictionary with fit results</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">fit_storage</span><span class="p">()</span>
    
    <span class="n">params</span><span class="p">[</span><span class="s">&#39;n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
    <span class="n">params</span><span class="p">[</span><span class="s">&#39;sb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sb</span>
    <span class="n">params</span><span class="p">[</span><span class="s">&#39;reffreq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>
    <span class="n">params</span><span class="p">[</span><span class="s">&#39;rms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rms</span>
    
    <span class="c"># Setup initial fit parameters</span>
    <span class="c"># Peak</span>
    <span class="n">tmin</span> <span class="o">=</span> <span class="n">tau</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> 
    <span class="n">peak_indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tau</span> <span class="o">==</span> <span class="n">tmin</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peak_indx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">peak_indx</span> <span class="o">=</span> <span class="n">peak_indx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
    <span class="c"># Peak velocity</span>
    <span class="k">if</span> <span class="n">v0</span><span class="p">:</span>
        <span class="n">vel0</span> <span class="o">=</span> <span class="n">v0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vel0</span> <span class="o">=</span> <span class="n">vel</span><span class="p">[</span><span class="n">peak_indx</span><span class="p">]</span> 
    <span class="c"># Line width</span>
    <span class="c"># Choose the minimum between 2 options for the line width</span>
    <span class="k">if</span> <span class="n">peak_indx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dv1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="n">peak_indx</span><span class="p">]</span> <span class="o">-</span> <span class="n">vel</span><span class="p">[</span><span class="n">peak_indx</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dv1</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">if</span> <span class="n">peak_indx</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dv2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="n">peak_indx</span><span class="p">]</span> <span class="o">-</span> <span class="n">vel</span><span class="p">[</span><span class="n">peak_indx</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dv2</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">sx0</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dv1</span><span class="p">,</span> <span class="n">dv2</span><span class="p">)</span>
    <span class="c"># Use the rms as optical depth offset from 0</span>
    <span class="n">A0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c">#np.mean([tbl[fit[&#39;ch0&#39;][i]:fit[&#39;ch0&#39;][i]+10].mean(), tbl[fit[&#39;chf&#39;][i]-10:fit[&#39;chf&#39;][i]].mean()])</span>
    
    <span class="n">npts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;p0: &quot;</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span><span class="n">vel0</span><span class="p">,</span><span class="n">sx0</span><span class="p">,</span><span class="n">A0</span>
        <span class="k">print</span> <span class="s">&quot;# unmasked points to fit: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npts</span><span class="p">)</span>
        
    <span class="c">#try:</span>
    <span class="c">#if npts &gt; nparams:</span>
    <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s">&#39;gauss&#39;</span><span class="p">:</span>
        <span class="n">gmod</span> <span class="o">=</span> <span class="n">GaussianModel</span><span class="p">()</span>
        <span class="n">cmod</span> <span class="o">=</span> <span class="n">ConstantModel</span><span class="p">()</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">cmod</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">vel</span><span class="p">)</span>
        <span class="n">pars</span> <span class="o">+=</span> <span class="n">gmod</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">vel0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sx0</span><span class="p">)</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">min</span><span class="o">=-</span><span class="mi">60</span><span class="p">,</span> <span class="nb">max</span><span class="o">=-</span><span class="mi">40</span><span class="p">)</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">gmod</span> <span class="o">+</span> <span class="n">cmod</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">vel</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s">&#39;gauss0&#39;</span><span class="p">:</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">GaussianModel</span><span class="p">()</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">vel</span><span class="p">)</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">vel0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mi">60</span><span class="p">,</span> <span class="nb">max</span><span class="o">=-</span><span class="mi">40</span><span class="p">)</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">vel</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s">&#39;2gauss&#39;</span><span class="p">:</span>
        <span class="n">gmod1</span> <span class="o">=</span> <span class="n">GaussianModel</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;g1_&#39;</span><span class="p">)</span>
        <span class="n">gmod2</span> <span class="o">=</span> <span class="n">GaussianModel</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;g2_&#39;</span><span class="p">)</span>
        <span class="n">cmod</span> <span class="o">=</span> <span class="n">ConstantModel</span><span class="p">()</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">cmod</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">vel</span><span class="p">)</span>
        <span class="n">pars</span> <span class="o">+=</span> <span class="n">gmod1</span><span class="o">.</span><span class="n">make_params</span><span class="p">()</span>
        <span class="n">pars</span> <span class="o">+=</span> <span class="n">gmod2</span><span class="o">.</span><span class="n">make_params</span><span class="p">()</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">gmod1</span> <span class="o">+</span> <span class="n">gmod2</span> <span class="o">+</span> <span class="n">cmod</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;g1_center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">vel0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mi">60</span><span class="p">,</span> <span class="nb">max</span><span class="o">=-</span><span class="mi">40</span><span class="p">)</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;g2_center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span> <span class="n">vel0</span><span class="o">+</span><span class="mf">9.4</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mi">60</span><span class="p">,</span> <span class="nb">max</span><span class="o">=-</span><span class="mi">40</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s">&#39;g1_center+9.4&#39;</span><span class="p">)</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;g1_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;g2_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">vel</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s">&#39;voigt0&#39;</span><span class="p">:</span>
        <span class="n">vmod</span> <span class="o">=</span> <span class="n">VoigtModel</span><span class="p">()</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">vmod</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">vel0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">vmod</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">vel0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">FWHM2sigma</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">vary</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">vel</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s">&#39;voigt&#39;</span><span class="p">:</span>
        <span class="n">vmod</span> <span class="o">=</span> <span class="n">VoigtModel</span><span class="p">()</span>
        <span class="n">cmod</span> <span class="o">=</span> <span class="n">ConstantModel</span><span class="p">()</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">cmod</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">vel</span><span class="p">)</span>
        <span class="n">pars</span> <span class="o">+=</span> <span class="n">vmod</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">vel0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">vmod</span> <span class="o">+</span> <span class="n">cmod</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="c">#pars[&#39;gamma&#39;].set(min=0.001, max=10000)</span>
        <span class="c">#pars[&#39;center&#39;].set(min=-60., max=-35.)</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">vel0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">FWHM2sigma</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">vary</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">vel</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s">&#39;voigt2&#39;</span><span class="p">:</span>
        <span class="n">vmod1</span> <span class="o">=</span> <span class="n">VoigtModel</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;v1_&#39;</span><span class="p">)</span>
        <span class="n">vmod2</span> <span class="o">=</span> <span class="n">VoigtModel</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;v2_&#39;</span><span class="p">)</span>
        <span class="n">cmod</span> <span class="o">=</span> <span class="n">ConstantModel</span><span class="p">()</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">cmod</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">vel</span><span class="p">)</span>
        <span class="n">pars</span> <span class="o">+=</span> <span class="n">vmod1</span><span class="o">.</span><span class="n">make_params</span><span class="p">()</span>
        <span class="n">pars</span> <span class="o">+=</span> <span class="n">vmod2</span><span class="o">.</span><span class="n">make_params</span><span class="p">()</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">vmod1</span> <span class="o">+</span> <span class="n">vmod2</span> <span class="o">+</span> <span class="n">cmod</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;v1_gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;v2_gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;v1_center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">vel0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;v2_center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">vel0</span><span class="o">+</span><span class="mf">9.4</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s">&#39;v1_center+9.4&#39;</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;v1_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">tmin</span><span class="p">)</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;v2_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">tmin</span><span class="p">)</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;v1_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">FWHM2sigma</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">vary</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">pars</span><span class="p">[</span><span class="s">&#39;v2_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">FWHM2sigma</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">vary</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">vel</span><span class="p">)</span>
        
    <span class="n">best_fit</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">best_fit</span>
    
    <span class="c"># Correct LMfit model definitions</span>
    <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s">&#39;gauss&#39;</span><span class="p">:</span>
        <span class="c"># Line center</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;vp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>   <span class="c"># Velocity of the peak</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dvp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
        <span class="c"># Line width</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dv1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;fwhm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>     <span class="c"># Line width in velocity</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;ddv1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;fwhm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
        <span class="c"># Peak optical depth</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> \
                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dtau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span> <span class="o">/</span> \
                            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="c"># Assume Gaussian profile for integrated optical depth</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;itau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;tau1&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;dv1&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span> 
        <span class="n">ditau1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;itau1&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;tau1&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;dtau1&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ditau2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;itau1&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;dv1&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;ddv1&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;ditau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ditau1</span> <span class="o">+</span> <span class="n">ditau2</span><span class="p">)</span>
    
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s">&#39;voigt&#39;</span> <span class="ow">or</span> <span class="n">model</span> <span class="o">==</span> <span class="s">&#39;voigt0&#39;</span><span class="p">:</span>
        <span class="c"># Line center</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;vp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>   <span class="c"># Velocity of the peak</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dvp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
        <span class="c"># Line width</span>
        <span class="c">#params[&#39;dv1&#39;] = fit.params[&#39;fwhm&#39;].value     # Line width in velocity</span>
        <span class="c">#params[&#39;ddv1&#39;] = fit.params[&#39;fwhm&#39;].stderr</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">dsigma</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">dD</span> <span class="o">=</span> <span class="n">sigma2FWHM</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
        <span class="n">ddD</span> <span class="o">=</span> <span class="n">sigma2FWHM</span><span class="p">(</span><span class="n">dsigma</span><span class="p">)</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">dgamma</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">dL</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">gamma</span>
        <span class="n">ddL</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">dgamma</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dv1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_width</span><span class="p">(</span><span class="n">dD</span><span class="p">,</span> <span class="n">dL</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;ddv1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_width_err</span><span class="p">(</span><span class="n">dD</span><span class="p">,</span> <span class="n">dL</span><span class="p">,</span> <span class="n">ddD</span><span class="p">,</span> <span class="n">ddL</span><span class="p">)</span>
        
        <span class="c"># Line amplitude</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;ptau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">best_fit</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> \
                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dtau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span> <span class="o">/</span> \
                         <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="c"># Line area</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;itau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">voigt_area</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;ptau&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;dv1&#39;</span><span class="p">],</span> 
                                     <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> 
                                     <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;ditau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">voigt_area_err</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;itau1&#39;</span><span class="p">],</span> 
                                          <span class="n">params</span><span class="p">[</span><span class="s">&#39;ptau&#39;</span><span class="p">],</span> 
                                          <span class="n">params</span><span class="p">[</span><span class="s">&#39;dtau1&#39;</span><span class="p">],</span> 
                                          <span class="n">params</span><span class="p">[</span><span class="s">&#39;dv1&#39;</span><span class="p">],</span> 
                                          <span class="n">params</span><span class="p">[</span><span class="s">&#39;ddv1&#39;</span><span class="p">],</span> 
                                          <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> 
                                          <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;ddL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;ddD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s">&#39;voigt2&#39;</span><span class="p">:</span>
        <span class="c"># Line center</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;vp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v1_center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>   <span class="c"># Velocity of the peak</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dvp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v1_center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;vp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v2_center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>   <span class="c"># Velocity of the peak</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dvp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v2_center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
        <span class="c"># Line width</span>
        <span class="c">#params[&#39;dv1&#39;] = fit.params[&#39;fwhm&#39;].value     # Line width in velocity</span>
        <span class="c">#params[&#39;ddv1&#39;] = fit.params[&#39;fwhm&#39;].stderr</span>
        <span class="c"># Line width</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v1_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">dsigma</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v1_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">dD</span> <span class="o">=</span> <span class="n">sigma2FWHM</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
        <span class="n">ddD</span> <span class="o">=</span> <span class="n">sigma2FWHM</span><span class="p">(</span><span class="n">dsigma</span><span class="p">)</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v1_gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">dgamma</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v1_gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">dL</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">gamma</span>
        <span class="n">ddL</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">dgamma</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dv1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_width</span><span class="p">(</span><span class="n">dD</span><span class="p">,</span> <span class="n">dL</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;ddv1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_width_err</span><span class="p">(</span><span class="n">dD</span><span class="p">,</span> <span class="n">dL</span><span class="p">,</span> <span class="n">ddD</span><span class="p">,</span> <span class="n">ddL</span><span class="p">)</span>
        
        <span class="c"># Line width</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v2_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">dsigma</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v2_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">dD</span> <span class="o">=</span> <span class="n">sigma2FWHM</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
        <span class="n">ddD</span> <span class="o">=</span> <span class="n">sigma2FWHM</span><span class="p">(</span><span class="n">dsigma</span><span class="p">)</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v2_gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">dgamma</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v2_gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">dL</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">gamma</span>
        <span class="n">ddL</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">dgamma</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dv2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_width</span><span class="p">(</span><span class="n">dD</span><span class="p">,</span> <span class="n">dL</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;ddv2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_width_err</span><span class="p">(</span><span class="n">dD</span><span class="p">,</span> <span class="n">dL</span><span class="p">,</span> <span class="n">ddD</span><span class="p">,</span> <span class="n">ddL</span><span class="p">)</span>
        
        <span class="c"># Line amplitude</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;ptau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">best_fit</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v1_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> \
                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v1_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dtau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v1_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span> <span class="o">/</span> \
                         <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v1_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tau2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v2_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> \
                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v2_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dtau2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v2_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span> <span class="o">/</span> \
                         <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v2_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="c"># Line area</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;itau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">voigt_area</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;tau1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;dv1&#39;</span><span class="p">],</span> 
                                     <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v1_gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> 
                                     <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v1_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;ditau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">voigt_area_err</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;itau1&#39;</span><span class="p">],</span> 
                                          <span class="n">params</span><span class="p">[</span><span class="s">&#39;tau1&#39;</span><span class="p">],</span> 
                                          <span class="n">params</span><span class="p">[</span><span class="s">&#39;dtau1&#39;</span><span class="p">],</span> 
                                          <span class="n">params</span><span class="p">[</span><span class="s">&#39;dv1&#39;</span><span class="p">],</span> 
                                          <span class="n">params</span><span class="p">[</span><span class="s">&#39;ddv1&#39;</span><span class="p">],</span> 
                                          <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v1_gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> 
                                          <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v1_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;itau2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">voigt_area</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;tau2&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;dv2&#39;</span><span class="p">],</span> 
                                     <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v2_gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> 
                                     <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v2_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;ditau2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">voigt_area_err</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;itau2&#39;</span><span class="p">],</span> 
                                          <span class="n">params</span><span class="p">[</span><span class="s">&#39;tau2&#39;</span><span class="p">],</span> 
                                          <span class="n">params</span><span class="p">[</span><span class="s">&#39;dtau2&#39;</span><span class="p">],</span> 
                                          <span class="n">params</span><span class="p">[</span><span class="s">&#39;dv2&#39;</span><span class="p">],</span> 
                                          <span class="n">params</span><span class="p">[</span><span class="s">&#39;ddv2&#39;</span><span class="p">],</span> 
                                          <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v2_gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> 
                                          <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v2_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v1_gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;ddL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v1_gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v1_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;ddD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v1_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dL2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v2_gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;ddL2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v2_gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dD2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v2_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;ddD2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;v2_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
        
    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s">&#39;2gauss&#39;</span><span class="p">:</span>
        <span class="c"># Peak optical depth</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g1_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> \
                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g1_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dtau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g1_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span> <span class="o">/</span> \
                            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g1_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tau2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g2_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> \
                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g2_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dtau2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g2_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span> <span class="o">/</span> \
                            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g2_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;vp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g1_center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>   <span class="c"># Velocity of the peak</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dvp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g1_center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dv1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g1_fwhm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>     <span class="c"># Line width in velocity</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;ddv1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g1_fwhm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;vp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g2_center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>   <span class="c"># Velocity of the peak</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dvp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g2_center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dv2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g2_fwhm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>     <span class="c"># Line width in velocity</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;ddv2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g2_fwhm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g1_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> \
                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g1_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dtau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g1_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span> <span class="o">/</span> \
                            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g1_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tau2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g2_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> \
                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g2_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dtau2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g2_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span> <span class="o">/</span> \
                            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;g2_sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;itau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;tau1&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;dv1&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span> 
        <span class="n">ditau1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;itau1&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;tau1&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;dtau1&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ditau2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;itau1&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;dv1&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;ddv1&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;ditau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ditau1</span> <span class="o">+</span> <span class="n">ditau2</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;itau2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;tau2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;dv2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span> 
        <span class="n">ditau1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;itau2&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;tau2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;dtau2&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ditau2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;itau2&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;dv2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;ddv2&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;ditau2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ditau1</span> <span class="o">+</span> <span class="n">ditau2</span><span class="p">)</span>
    <span class="c">#print model</span>
    <span class="k">if</span> <span class="s">&#39;0&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tau0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;c&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>      <span class="c"># Spectrum constant offset from 0</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dtau0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;c&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;tau0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;dtau0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rms</span>
    
        
    <span class="c"># Godness of fit</span>
    <span class="n">params</span><span class="p">[</span><span class="s">&#39;chi2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">chisqr</span>
    <span class="n">params</span><span class="p">[</span><span class="s">&#39;chiv2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">redchi</span>
    <span class="n">params</span><span class="p">[</span><span class="s">&#39;res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fit</span><span class="o">.</span><span class="n">residual</span><span class="p">)</span>
        
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Velocity fit results&quot;</span>
        <span class="k">print</span> <span class="n">fit</span><span class="o">.</span><span class="n">fit_report</span><span class="p">()</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">&quot;Integrated optical depth:&quot;</span><span class="p">),</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">&quot;{0} +/- {1} km/s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;itau1&#39;</span><span class="p">],</span>
                                            <span class="n">params</span><span class="p">[</span><span class="s">&#39;ditau1&#39;</span><span class="p">]))</span>
    
    <span class="k">return</span> <span class="n">best_fit</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">fit</span><span class="o">.</span><span class="n">residual</span><span class="p">,</span> <span class="n">fit</span>
</div>
<div class="viewcode-block" id="fit_storage"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.fit_storage">[docs]</a><span class="k">def</span> <span class="nf">fit_storage</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a dictionary with the </span>
<span class="sd">    entries for the parameters to </span>
<span class="sd">    be fitted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Fit results</span>
    <span class="c">#if model == gaussian</span>
    <span class="n">blankval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">99</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(((</span><span class="s">&#39;sb&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>       <span class="c">#0 Sub Band number</span>
                                   <span class="p">(</span><span class="s">&#39;n&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>        <span class="c">#1 Principal quantum number</span>
                                   <span class="p">(</span><span class="s">&#39;reffreq&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>  <span class="c">#2 Reference frequency</span>
                                   <span class="p">(</span><span class="s">&#39;tau1&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>     <span class="c">#3 Peak optical depth</span>
                                   <span class="p">(</span><span class="s">&#39;vp1&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>      <span class="c">#4 Velocity of peak optical depth</span>
                                   <span class="p">(</span><span class="s">&#39;dv1&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>      <span class="c">#5 Line width</span>
                                   <span class="p">(</span><span class="s">&#39;itau1&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>    <span class="c">#6 Integrated optical depth</span>
                                   <span class="p">(</span><span class="s">&#39;tau0&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>     <span class="c">#7 Optical depth offset</span>
                                   <span class="p">(</span><span class="s">&#39;dtau1&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>    <span class="c">#8 Peak optical depth error</span>
                                   <span class="p">(</span><span class="s">&#39;dvp1&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>     <span class="c">#9 Velocity of peak optical depth error</span>
                                   <span class="p">(</span><span class="s">&#39;ddv1&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>     <span class="c">#10 Line width error</span>
                                   <span class="p">(</span><span class="s">&#39;ditau1&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>   <span class="c">#11 Integrated optical depth error</span>
                                   <span class="p">(</span><span class="s">&#39;dtau0&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>    <span class="c">#12 Optical depth offset error</span>
                                   <span class="p">(</span><span class="s">&#39;dD&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>       <span class="c">#13</span>
                                   <span class="p">(</span><span class="s">&#39;ddD&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>      <span class="c">#14</span>
                                   <span class="p">(</span><span class="s">&#39;dL&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>       <span class="c">#15</span>
                                   <span class="p">(</span><span class="s">&#39;ddL&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>      <span class="c">#16</span>
                                   <span class="p">(</span><span class="s">&#39;chiv2&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>    <span class="c">#17 Reduced Chi squared</span>
                                   <span class="p">(</span><span class="s">&#39;chi2&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>     <span class="c">#18 Chi squared</span>
                                   <span class="p">(</span><span class="s">&#39;res&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>      <span class="c">#19 Fit residuals</span>
                                   <span class="p">(</span><span class="s">&#39;rms&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>      <span class="c">#20 Continuum rms</span>
                                   <span class="p">(</span><span class="s">&#39;pres&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>     <span class="c">#21 Peak residual</span>
                                   <span class="p">(</span><span class="s">&#39;flag&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>     <span class="c">#22 Fit result flag</span>
                                   <span class="p">(</span><span class="s">&#39;tau2&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>     <span class="c">#23</span>
                                   <span class="p">(</span><span class="s">&#39;vp2&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>      <span class="c">#24</span>
                                   <span class="p">(</span><span class="s">&#39;dv2&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>      <span class="c">#25</span>
                                   <span class="p">(</span><span class="s">&#39;itau2&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>    <span class="c">#26</span>
                                   <span class="p">(</span><span class="s">&#39;dtau2&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>    <span class="c">#27</span>
                                   <span class="p">(</span><span class="s">&#39;dvp2&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>     <span class="c">#28</span>
                                   <span class="p">(</span><span class="s">&#39;ddv2&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>     <span class="c">#29</span>
                                   <span class="p">(</span><span class="s">&#39;ditau2&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>   <span class="c">#30</span>
                                   <span class="p">(</span><span class="s">&#39;dD2&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>      <span class="c">#31</span>
                                   <span class="p">(</span><span class="s">&#39;ddD2&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>     <span class="c">#32</span>
                                   <span class="p">(</span><span class="s">&#39;dL2&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>      <span class="c">#33</span>
                                   <span class="p">(</span><span class="s">&#39;ddL2&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>     <span class="c">#34</span>
                                   <span class="p">(</span><span class="s">&#39;ptau&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">)))</span>    <span class="c">#35</span>
    

    <span class="k">return</span> <span class="n">fit</span>
</div>
<div class="viewcode-block" id="freq2vel"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.freq2vel">[docs]</a><span class="k">def</span> <span class="nf">freq2vel</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a frequency axis</span>
<span class="sd">    to a velocity axis given</span>
<span class="sd">    a central frequency.</span>
<span class="sd">    Uses the radio definition </span>
<span class="sd">    of velocity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">f</span><span class="o">/</span><span class="n">f0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FWHM2sigma"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.FWHM2sigma">[docs]</a><span class="k">def</span> <span class="nf">FWHM2sigma</span><span class="p">(</span><span class="n">fwhm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a FWHM to the standard deviation of </span>
<span class="sd">    a Gaussian distribution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">return</span> <span class="n">fwhm</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="Gauss"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.Gauss">[docs]</a><span class="k">def</span> <span class="nf">Gauss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies a Gaussian filter to y.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">gauss</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;sigma&#39;</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;order&#39;</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">gauss</span>
</div>
<div class="viewcode-block" id="gauss_area"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.gauss_area">[docs]</a><span class="k">def</span> <span class="nf">gauss_area</span><span class="p">(</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the area under a Gaussian of a </span>
<span class="sd">    given amplitude and sigma.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">return</span> <span class="n">amplitude</span><span class="o">*</span><span class="n">sigma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="gauss_area_err"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.gauss_area_err">[docs]</a><span class="k">def</span> <span class="nf">gauss_area_err</span><span class="p">(</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">amplitude_err</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">sigma_err</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">err1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">amplitude_err</span><span class="o">*</span><span class="n">sigma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">err2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">sigma_err</span><span class="o">*</span><span class="n">amplitude</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">err1</span> <span class="o">+</span> <span class="n">err2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Gaussian"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.Gaussian">[docs]</a><span class="k">def</span> <span class="nf">Gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    1-d Gaussian with no amplitude offset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">return</span> <span class="n">amplitude</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">center</span><span class="p">),</span> <span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="gaussian_off"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.gaussian_off">[docs]</a><span class="k">def</span> <span class="nf">gaussian_off</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    1-d Gaussian with a constant amplitude offset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">return</span> <span class="n">amplitude</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">center</span><span class="p">),</span> <span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">sigma</span><span class="o">**</span><span class="mf">2.</span><span class="p">))</span> <span class="o">+</span> <span class="n">c</span>
</div>
<div class="viewcode-block" id="get_axis"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.get_axis">[docs]</a><span class="k">def</span> <span class="nf">get_axis</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constructs a cube axis</span>
<span class="sd">    @param header - fits cube header</span>
<span class="sd">    @type header - pyfits header</span>
<span class="sd">    @param axis - axis to reconstruct</span>
<span class="sd">    @type axis - int</span>
<span class="sd">    @return - cube axis</span>
<span class="sd">    @rtype - numpy array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">axis</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;CDELT&quot;</span> <span class="o">+</span> <span class="n">axis</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;CRPIX&quot;</span> <span class="o">+</span> <span class="n">axis</span><span class="p">)</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;CRPIX&quot;</span> <span class="o">+</span> <span class="n">axis</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;CRVAL&quot;</span> <span class="o">+</span> <span class="n">axis</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;NAXIS&quot;</span> <span class="o">+</span> <span class="n">axis</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x0</span> <span class="o">-</span> <span class="n">p0</span><span class="o">*</span><span class="n">dx</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="n">p0</span><span class="o">*</span><span class="n">dx</span> <span class="o">+</span> <span class="n">n</span><span class="o">*</span><span class="n">dx</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="get_line_mask"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.get_line_mask">[docs]</a><span class="k">def</span> <span class="nf">get_line_mask</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">reffreq</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">dv0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a mask with ranges </span>
<span class="sd">    where a line is expected in</span>
<span class="sd">    the given frequency range for</span>
<span class="sd">    a line with a given reference </span>
<span class="sd">    frequency at expected velocity </span>
<span class="sd">    v0 and line width dv0.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c">#print v0</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="n">vel2freq</span><span class="p">(</span><span class="n">reffreq</span><span class="p">,</span> <span class="n">v0</span><span class="o">*</span><span class="mf">1e3</span><span class="p">)</span>
    <span class="c">#print &quot;Line location in frequency {0} MHz&quot;.format(f0)</span>
    <span class="n">df0</span> <span class="o">=</span> <span class="n">dv2df</span><span class="p">(</span><span class="n">reffreq</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">dv0</span><span class="o">*</span><span class="mf">1e3</span><span class="p">)</span>
    <span class="c">#print &quot;Line width in frequency {0} Hz&quot;.format(df0)</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">freq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">freq</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c">#print &quot;Channel width {} Hz&quot;.format(df*1e6)</span>
    
    <span class="n">f0_indx</span> <span class="o">=</span> <span class="n">best_match_indx</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">df</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="c">#f0_indx = abs(freq - f0).argmin()</span>
    <span class="c">#print &quot;Frequency index: {}&quot;.format(f0_indx)</span>
    
    <span class="c">#print &quot;Line width in channels: {}&quot;.format(df0/df/1e6)</span>
    
    <span class="n">mindx0</span> <span class="o">=</span> <span class="n">f0_indx</span> <span class="o">-</span> <span class="n">df0</span><span class="o">/</span><span class="n">df</span><span class="o">/</span><span class="mf">1e6</span>
    <span class="n">mindxf</span> <span class="o">=</span> <span class="n">f0_indx</span> <span class="o">+</span> <span class="n">df0</span><span class="o">/</span><span class="n">df</span><span class="o">/</span><span class="mf">1e6</span>
    
    <span class="c">#print mindx0, mindxf</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">mindx0</span><span class="p">,</span> <span class="n">mindxf</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="get_line_mask2"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.get_line_mask2">[docs]</a><span class="k">def</span> <span class="nf">get_line_mask2</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">reffreq</span><span class="p">,</span> <span class="n">dv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a mask with ranges </span>
<span class="sd">    where a line is expected in</span>
<span class="sd">    the given frequency range for</span>
<span class="sd">    a line with a given reference </span>
<span class="sd">    frequency and line width dv.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">dv2df</span><span class="p">(</span><span class="n">reffreq</span><span class="p">,</span> <span class="n">dv</span><span class="o">*</span><span class="mf">1e3</span><span class="p">)</span>
    <span class="n">df_chan</span> <span class="o">=</span> <span class="n">get_min_sep</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
    <span class="n">f0_indx</span> <span class="o">=</span> <span class="n">best_match_indx2</span><span class="p">(</span><span class="n">reffreq</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span>

    <span class="n">f_mini</span> <span class="o">=</span> <span class="n">f0_indx</span> <span class="o">-</span> <span class="n">df</span><span class="o">/</span><span class="n">df_chan</span>
    <span class="k">if</span> <span class="n">f_mini</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">f_mini</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">f_maxi</span> <span class="o">=</span> <span class="n">f0_indx</span> <span class="o">+</span> <span class="n">df</span><span class="o">/</span><span class="n">df_chan</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">f_mini</span><span class="p">,</span> <span class="n">f_maxi</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="get_rms"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.get_rms">[docs]</a><span class="k">def</span> <span class="nf">get_rms</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> \
           <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">rms</span>
</div>
<div class="viewcode-block" id="get_min_sep"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.get_min_sep">[docs]</a><span class="k">def</span> <span class="nf">get_min_sep</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the minimum element separation in</span>
<span class="sd">    an array.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">da</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">da</span>
</div>
<div class="viewcode-block" id="is_number"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.is_number">[docs]</a><span class="k">def</span> <span class="nf">is_number</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks wether a string is a number or not.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="linear"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.linear">[docs]</a><span class="k">def</span> <span class="nf">linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Linear model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">b</span>
</div>
<div class="viewcode-block" id="line_width"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.line_width">[docs]</a><span class="k">def</span> <span class="nf">line_width</span><span class="p">(</span><span class="n">dD</span><span class="p">,</span> <span class="n">dL</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://en.wikipedia.org/wiki/Voigt_profile#The_width_of_the_Voigt_profile</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mf">0.5346</span><span class="p">,</span> <span class="n">dL</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mf">0.2166</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dL</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dD</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="line_width_err"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.line_width_err">[docs]</a><span class="k">def</span> <span class="nf">line_width_err</span><span class="p">(</span><span class="n">dD</span><span class="p">,</span> <span class="n">dL</span><span class="p">,</span> <span class="n">ddD</span><span class="p">,</span> <span class="n">ddL</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the error in the FWHM of</span>
<span class="sd">    a Voigt profile.</span>
<span class="sd">    http://en.wikipedia.org/wiki/Voigt_profile#The_width_of_the_Voigt_profile</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">f</span> <span class="o">=</span> <span class="mf">0.02</span><span class="o">/</span><span class="mf">100.</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.5346</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">0.2166</span>
    
    <span class="n">dT1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">dL</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dL</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dD</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">ddL</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">dT2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">dD</span><span class="p">,</span> <span class="n">ddD</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dL</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dD</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">dT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dT1</span> <span class="o">+</span> <span class="n">dT2</span><span class="p">)</span>
    
    <span class="n">dT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dT</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">f</span><span class="o">*</span><span class="n">line_width</span><span class="p">(</span><span class="n">dD</span><span class="p">,</span> <span class="n">dL</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">dT</span>
</div>
<div class="viewcode-block" id="load_model"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.load_model">[docs]</a><span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">specie</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">dens</span><span class="p">,</span> <span class="n">other</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads a model for the CRRL emission.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">LOCALDIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
    <span class="n">ldir</span> <span class="o">=</span> <span class="s">&quot;{0}/{1}/{2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LOCALDIR</span><span class="p">,</span> <span class="s">&#39;models&#39;</span><span class="p">,</span> <span class="s">&#39;radtrans&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">specie</span> <span class="o">==</span> <span class="s">&#39;alpha&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">other</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;width&#39;</span> <span class="ow">in</span> <span class="n">prop</span><span class="p">:</span>
                <span class="n">mod_file</span> <span class="o">=</span> <span class="s">&#39;{0}/Diffuse_CMB_bn_velturb_{1}_{2}_{3}_linewidth.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ldir</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">dens</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mod_file</span> <span class="o">=</span> <span class="s">&#39;{0}/Diffuse_CMB_bn_velturb_{1}_{2}_{3}_line.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ldir</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">dens</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;width&#39;</span> <span class="ow">in</span> <span class="n">prop</span><span class="p">:</span>
                <span class="n">mod_file</span> <span class="o">=</span> <span class="s">&#39;{0}/Diffuse_CMB_bn_velturb_{1}_{2}_linewidth.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ldir</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">dens</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mod_file</span> <span class="o">=</span> <span class="s">&#39;{0}/Diffuse_CMB_bn_velturb_{1}_{2}_line.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ldir</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">dens</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">other</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;width&#39;</span> <span class="ow">in</span> <span class="n">prop</span><span class="p">:</span>
                <span class="n">mod_file</span> <span class="o">=</span> <span class="s">&#39;{0}/Diffuse_CMB_bn_velturb_{4}_{1}_{2}_{3}_linewidth.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ldir</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">dens</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">specie</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mod_file</span> <span class="o">=</span> <span class="s">&#39;{0}/Diffuse_CMB_bn_velturb_{4}_{1}_{2}_{3}_line.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ldir</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">dens</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">specie</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;width&#39;</span> <span class="ow">in</span> <span class="n">prop</span><span class="p">:</span>
                <span class="n">mod_file</span> <span class="o">=</span> <span class="s">&#39;{0}/Diffuse_CMB_bn_velturb_{4}_{1}_{2}_linewidth.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ldir</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">dens</span><span class="p">,</span> <span class="n">specie</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mod_file</span> <span class="o">=</span> <span class="s">&#39;{0}/Diffuse_CMB_bn_velturb_{4}_{1}_{2}_line.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ldir</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">dens</span><span class="p">,</span> <span class="n">specie</span><span class="p">)</span>
    
    <span class="n">model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">mod_file</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="s">&#39;width&#39;</span> <span class="ow">in</span> <span class="n">prop</span><span class="p">:</span>
        
        <span class="n">qni</span> <span class="o">=</span> <span class="n">model</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">qnf</span> <span class="o">=</span> <span class="n">model</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">model</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">dD</span> <span class="o">=</span> <span class="n">model</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">dLc</span> <span class="o">=</span> <span class="n">model</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">dLr</span> <span class="o">=</span> <span class="n">model</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">model</span><span class="p">[:,</span><span class="mi">6</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">qni</span><span class="p">,</span> <span class="n">qnf</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dD</span><span class="p">,</span> <span class="n">dLc</span><span class="p">,</span> <span class="n">dLr</span><span class="p">,</span> <span class="n">I</span><span class="p">])</span>
    
    <span class="k">else</span><span class="p">:</span>
        
        <span class="n">qn</span> <span class="o">=</span> <span class="n">model</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">model</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Ic</span> <span class="o">=</span> <span class="n">model</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">model</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">eta_nu</span> <span class="o">=</span> <span class="n">model</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">qn</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">Ic</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">eta_nu</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="load_ref"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.load_ref">[docs]</a><span class="k">def</span> <span class="nf">load_ref</span><span class="p">(</span><span class="n">specie</span><span class="p">,</span> <span class="n">trans</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads the reference spectrum for the</span>
<span class="sd">    specified atomic specie and transition.</span>
<span class="sd">    Available species and transitions: </span>
<span class="sd">    CI alpha</span>
<span class="sd">    CI beta</span>
<span class="sd">    CI delta</span>
<span class="sd">    CI gamma</span>
<span class="sd">    CI13 alpha</span>
<span class="sd">    HeI alpha</span>
<span class="sd">    HeI beta</span>
<span class="sd">    HI alpha</span>
<span class="sd">    HI beta</span>
<span class="sd">    SI alpha</span>
<span class="sd">    SI beta</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">LOCALDIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
    <span class="n">refspec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/linelist/RRL_{1}{2}.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LOCALDIR</span><span class="p">,</span> <span class="n">specie</span><span class="p">,</span> <span class="n">trans</span><span class="p">),</span>
                         <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                         <span class="c">#dtype={&#39;formats&#39;: (&#39;S4&#39;, &#39;S5&#39;, &#39;i4&#39;, &#39;f10&#39;)})</span>
    <span class="n">qn</span> <span class="o">=</span> <span class="n">refspec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">reffreq</span> <span class="o">=</span> <span class="n">refspec</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">qn</span><span class="p">,</span> <span class="n">reffreq</span>
</div>
<div class="viewcode-block" id="load_ref2"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.load_ref2">[docs]</a><span class="k">def</span> <span class="nf">load_ref2</span><span class="p">(</span><span class="n">transition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads the reference spectrum for the</span>
<span class="sd">    specified atomic specie and transition.</span>
<span class="sd">    Available transitions: </span>
<span class="sd">    CIalpha</span>
<span class="sd">    CIbeta</span>
<span class="sd">    CIdelta</span>
<span class="sd">    CIgamma</span>
<span class="sd">    CI13alpha</span>
<span class="sd">    HeIalpha</span>
<span class="sd">    HeIbeta</span>
<span class="sd">    HIalpha</span>
<span class="sd">    HIbeta</span>
<span class="sd">    SIalpha</span>
<span class="sd">    SIbeta</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">LOCALDIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
    <span class="n">refspec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/linelist/RRL_{1}.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LOCALDIR</span><span class="p">,</span> <span class="n">transition</span><span class="p">),</span>
                         <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">qn</span> <span class="o">=</span> <span class="n">refspec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">reffreq</span> <span class="o">=</span> <span class="n">refspec</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">qn</span><span class="p">,</span> <span class="n">reffreq</span>
</div>
<div class="viewcode-block" id="lookup_freq"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.lookup_freq">[docs]</a><span class="k">def</span> <span class="nf">lookup_freq</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">specie</span><span class="p">,</span> <span class="n">trans</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the frequency of a given transition.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">qns</span><span class="p">,</span> <span class="n">freqs</span> <span class="o">=</span> <span class="n">load_ref</span><span class="p">(</span><span class="n">specie</span><span class="p">,</span> <span class="n">trans</span><span class="p">)</span>
    <span class="n">indx</span> <span class="o">=</span> <span class="n">best_match_indx2</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">qns</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">freqs</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="lorentz_width"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.lorentz_width">[docs]</a><span class="k">def</span> <span class="nf">lorentz_width</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">Te</span><span class="p">,</span> <span class="n">Tr</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">dn</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gives the Lorentzian line width due to a combination</span>
<span class="sd">    of radiation and collisional broadening. The width</span>
<span class="sd">    is the FWHM in Hz. It uses the models of Salgado et al. (2015).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">dL_r</span> <span class="o">=</span> <span class="n">radiation_broad_salgado</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">Tr</span><span class="p">)</span>
    <span class="n">dL_p</span> <span class="o">=</span> <span class="n">pressure_broad_salgado</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Te</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">dn</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">dL_r</span> <span class="o">+</span> <span class="n">dL_p</span>
</div>
<div class="viewcode-block" id="mask_outliers"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.mask_outliers">[docs]</a><span class="k">def</span> <span class="nf">mask_outliers</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Masks values larger than m times the data median.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">m</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="natural_sort"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.natural_sort">[docs]</a><span class="k">def</span> <span class="nf">natural_sort</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Sort the given list in the way that humans expect.</span>
<span class="sd">    Sorting is done in place.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">l</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">alphanum_key</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="n2f"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.n2f">[docs]</a><span class="k">def</span> <span class="nf">n2f</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">n_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_max</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">unitless</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a given principal quantum number n to the </span>
<span class="sd">    frequency of a given line.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">line</span><span class="p">,</span> <span class="n">nn</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">make_line_list</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">n_min</span><span class="p">,</span> <span class="n">n_max</span><span class="p">,</span> <span class="n">unitless</span><span class="p">)</span>
    <span class="n">nii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">freq</span><span class="p">[</span><span class="n">nii</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="plot_spec_vel"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.plot_spec_vel">[docs]</a><span class="k">def</span> <span class="nf">plot_spec_vel</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">Aerr</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x0err</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sxerr</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s">&#39;datalim&#39;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s">&#39;k-&#39;</span><span class="p">,</span> <span class="n">drawstyle</span><span class="o">=</span><span class="s">&#39;steps&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span> <span class="s">&#39;r--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="c">#ax.plot()</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> 
            <span class="s">r&quot;$\sigma v_{{line}}=${0:.1f}$\pm${1:.1f} km s$^{{-1}}$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sxerr</span><span class="p">),</span>
            <span class="n">size</span><span class="o">=</span><span class="s">&quot;large&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="s">r&quot;$v_{{line}}=${0:.1f}$\pm${1:.1f} km s$^{{-1}}$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x0err</span><span class="p">),</span> 
            <span class="n">size</span><span class="o">=</span><span class="s">&quot;large&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s">r&quot;$\tau_{{peak}}=${0:.4f}$\pm${1:.4f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Aerr</span><span class="p">),</span> 
            <span class="n">size</span><span class="o">=</span><span class="s">&quot;large&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">r&quot;Radio velocity (km s$^{-1}$)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">r&quot;$\tau$&quot;</span><span class="p">)</span>
        
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> 
                <span class="n">bbox_inches</span><span class="o">=</span><span class="s">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="plot_model"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.plot_model">[docs]</a><span class="k">def</span> <span class="nf">plot_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xm</span><span class="p">,</span> <span class="n">ym</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
    
    <span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s">&#39;datalim&#39;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s">&#39;k-&#39;</span><span class="p">,</span> <span class="n">drawstyle</span><span class="o">=</span><span class="s">&#39;steps&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s">&#39;pre&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xm</span><span class="p">,</span><span class="n">ym</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="s">&#39;--&#39;</span><span class="p">,</span> <span class="n">drawstyle</span><span class="o">=</span><span class="s">&#39;steps&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s">&#39;pre&#39;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&quot;Radio velocity (km s$^{-1}$)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&quot;$\tau$&quot;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> 
                <span class="n">bbox_inches</span><span class="o">=</span><span class="s">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="plot_fit"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.plot_fit">[docs]</a><span class="k">def</span> <span class="nf">plot_fit</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vparams</span><span class="p">,</span> <span class="n">sparams</span><span class="p">,</span> <span class="n">rms</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> \
             <span class="n">refs</span><span class="p">,</span> <span class="n">refs_cb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">refs_cd</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">refs_cg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    
    <span class="n">fc</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="s">&#39;g&#39;</span><span class="p">]</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">&#39;SB{0}, $n=${1:.0f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;sb&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;n&#39;</span><span class="p">]))</span>
    
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s">&#39;datalim&#39;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s">&#39;k-&#39;</span><span class="p">,</span> <span class="n">drawstyle</span><span class="o">=</span><span class="s">&#39;steps&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s">&#39;pre&#39;</span><span class="p">)</span>
    <span class="c">#ax.plot(refs, [y.max()]*len(refs), &#39;kd&#39;, alpha=0.5)</span>
    <span class="c">#if refs_cb:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">refs_cb</span><span class="p">,</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">refs_cb</span><span class="p">),</span> <span class="s">&#39;rd&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">refs_cd</span><span class="p">,</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">refs_cd</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;orange&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">refs_cd</span><span class="p">,</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">refs_cd</span><span class="p">),</span> <span class="s">&#39;yd&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
        
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fit</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="s">&#39;{0}--&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="s">&#39;{0}:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="n">f</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;tau0&#39;</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#39;k--&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;tau0&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">rms</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#39;k:&#39;</span><span class="p">)</span>
    <span class="c">#ax.plot()</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> 
            <span class="s">r&quot;FWHM$_{{line}}=${0:.1f}$\pm${1:.1f} km s$^{{-1}}$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;dv1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;ddv1&#39;</span><span class="p">]),</span>
            <span class="n">size</span><span class="o">=</span><span class="s">&quot;small&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.17</span><span class="p">,</span> <span class="s">r&quot;$v_{{line}}=${0:.1f}$\pm${1:.1f} km s$^{{-1}}$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;vp1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;dvp1&#39;</span><span class="p">]),</span> 
            <span class="n">size</span><span class="o">=</span><span class="s">&quot;small&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.23</span><span class="p">,</span> <span class="s">r&quot;$\tau_{{peak}}=${0:.4f}$\pm${1:.4f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;tau1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;dtau1&#39;</span><span class="p">]),</span> 
            <span class="n">size</span><span class="o">=</span><span class="s">&quot;small&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.33</span><span class="p">,</span> <span class="s">r&quot;$\int\tau dv=${0:.4f}$\pm${1:.4f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;itau1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;ditau1&#39;</span><span class="p">]),</span> 
            <span class="n">size</span><span class="o">=</span><span class="s">&quot;small&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="c">#ax.text(0.6, 0.25, r&quot;$n=${0:.0f}&quot;.format(params[&#39;n&#39;]),</span>
            <span class="c">#size=&quot;large&quot;, transform=ax.transAxes, alpha=0.9)</span>
    <span class="c">#ax.text(0.6, 0.3, r&quot;SB{0}&quot;.format(params[&#39;sb&#39;]),</span>
            <span class="c">#size=&quot;large&quot;, transform=ax.transAxes, alpha=0.9)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&quot;Radio velocity (km s$^{-1}$)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&quot;$\tau$&quot;</span><span class="p">)</span>
    
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s">&#39;datalim&#39;</span><span class="p">)</span>
    
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">refs_cb</span><span class="p">,</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">refs_cb</span><span class="p">),</span> <span class="s">&#39;rd&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">refs_cd</span><span class="p">,</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">refs_cd</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;orange&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">refs_cd</span><span class="p">,</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">refs_cd</span><span class="p">),</span> <span class="s">&#39;yd&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
    
    <span class="n">ax2</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s">&#39;k-&#39;</span><span class="p">,</span> <span class="n">drawstyle</span><span class="o">=</span><span class="s">&#39;steps&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s">&#39;pre&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fit</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="s">&#39;{0}--&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="s">&#39;{0}:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="n">f</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;tau0&#39;</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#39;k--&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;tau0&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;dtau0&#39;</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#39;k:&#39;</span><span class="p">)</span>
    <span class="n">ch0</span> <span class="o">=</span> <span class="n">sparams</span><span class="p">[</span><span class="s">&#39;ch0&#39;</span><span class="p">]</span>
    <span class="n">chf</span> <span class="o">=</span> <span class="n">sparams</span><span class="p">[</span><span class="s">&#39;chf&#39;</span><span class="p">]</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ch0</span><span class="p">:</span><span class="n">chf</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">ch0</span><span class="p">:</span><span class="n">chf</span><span class="p">],</span> <span class="n">x0</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    
    <span class="n">vp</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;vp1&#39;</span><span class="p">]</span>
    <span class="n">dv</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;dv1&#39;</span><span class="p">])</span>
    <span class="c">#ax2.set_xlim(vp - 6*dv, vp + 6*dv)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span>
</div>
<div class="viewcode-block" id="plot_fit_single"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.plot_fit_single">[docs]</a><span class="k">def</span> <span class="nf">plot_fit_single</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">rms</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> \
             <span class="n">refs</span><span class="p">,</span> <span class="n">refs_cb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">refs_cd</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">refs_cg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    
    <span class="n">fc</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="s">&#39;g&#39;</span><span class="p">]</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">&#39;SB{0}, $n=${1:.0f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;sb&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;n&#39;</span><span class="p">]))</span>
    
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s">&#39;datalim&#39;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s">&#39;k-&#39;</span><span class="p">,</span> <span class="n">drawstyle</span><span class="o">=</span><span class="s">&#39;steps&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s">&#39;pre&#39;</span><span class="p">)</span>
    <span class="c">#ax.plot(x, y, &#39;k-&#39;)</span>
    <span class="c">#ax.plot(refs, [y.max()]*len(refs), &#39;kd&#39;, alpha=0.5)</span>
    <span class="c">#if refs_cb:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">refs_cb</span><span class="p">,</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">refs_cb</span><span class="p">),</span> <span class="s">&#39;rd&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">refs_cd</span><span class="p">,</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">refs_cd</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;orange&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">refs_cd</span><span class="p">,</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">refs_cd</span><span class="p">),</span> <span class="s">&#39;yd&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
        
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fit</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="s">&#39;{0}--&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="s">&#39;{0}:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="n">f</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;tau0&#39;</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#39;k--&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;tau0&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">rms</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#39;k:&#39;</span><span class="p">)</span>
    <span class="c">#ax.plot()</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> 
            <span class="s">r&quot;FWHM$_{{line}}=${0:.1f}$\pm${1:.1f} km s$^{{-1}}$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;dv1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;ddv1&#39;</span><span class="p">]),</span>
            <span class="n">size</span><span class="o">=</span><span class="s">&quot;small&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.17</span><span class="p">,</span> <span class="s">r&quot;$v_{{line}}=${0:.1f}$\pm${1:.1f} km s$^{{-1}}$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;vp1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;dvp1&#39;</span><span class="p">]),</span> 
            <span class="n">size</span><span class="o">=</span><span class="s">&quot;small&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.23</span><span class="p">,</span> <span class="s">r&quot;$\tau_{{peak}}=${0:.6f}$\pm${1:.6f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;tau1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;dtau1&#39;</span><span class="p">]),</span> 
            <span class="n">size</span><span class="o">=</span><span class="s">&quot;small&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.33</span><span class="p">,</span> <span class="s">r&quot;$\int\tau dv=${0:.6f}$\pm${1:.6f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;itau1&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;ditau1&#39;</span><span class="p">]),</span> 
            <span class="n">size</span><span class="o">=</span><span class="s">&quot;small&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="c">#ax.text(0.6, 0.25, r&quot;$n=${0:.0f}&quot;.format(params[&#39;n&#39;]),</span>
            <span class="c">#size=&quot;large&quot;, transform=ax.transAxes, alpha=0.9)</span>
    <span class="c">#ax.text(0.6, 0.3, r&quot;SB{0}&quot;.format(params[&#39;sb&#39;]),</span>
            <span class="c">#size=&quot;large&quot;, transform=ax.transAxes, alpha=0.9)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&quot;Radio velocity (km s$^{-1}$)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&quot;$\tau$&quot;</span><span class="p">)</span>
    
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s">&#39;datalim&#39;</span><span class="p">)</span>
    
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">refs_cb</span><span class="p">,</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">refs_cb</span><span class="p">),</span> <span class="s">&#39;rd&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">refs_cd</span><span class="p">,</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">refs_cd</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;orange&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">refs_cd</span><span class="p">,</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">refs_cd</span><span class="p">),</span> <span class="s">&#39;yd&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
    
    <span class="n">ax2</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s">&#39;k-&#39;</span><span class="p">,</span> <span class="n">drawstyle</span><span class="o">=</span><span class="s">&#39;steps&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s">&#39;pre&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fit</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="s">&#39;{0}--&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="s">&#39;{0}:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="n">f</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;tau0&#39;</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#39;k--&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;tau0&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;dtau0&#39;</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#39;k:&#39;</span><span class="p">)</span>
    
    <span class="n">vp</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;vp1&#39;</span><span class="p">]</span>
    <span class="n">dv</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;dv1&#39;</span><span class="p">])</span>
    <span class="c">#ax2.set_xlim(vp - 6*dv, vp + 6*dv)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">fig</span>
</div>
<div class="viewcode-block" id="pressure_broad"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.pressure_broad">[docs]</a><span class="k">def</span> <span class="nf">pressure_broad</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Te</span><span class="p">,</span> <span class="n">ne</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pressure induced broadening in Hz.</span>
<span class="sd">    Shaver (1975)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">return</span> <span class="mf">2e-5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">Te</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">26.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">Te</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">))</span><span class="o">*</span><span class="n">ne</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mf">5.2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="pressure_broad_salgado"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.pressure_broad_salgado">[docs]</a><span class="k">def</span> <span class="nf">pressure_broad_salgado</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Te</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">dn</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pressure induced broadening in Hz.</span>
<span class="sd">    This gives the FWHM of a Lorentzian line.</span>
<span class="sd">    Salgado et al. (2015)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="n">pressure_broad_coefs</span><span class="p">(</span><span class="n">Te</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ne</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">dn</span><span class="p">,</span> <span class="n">g</span><span class="p">))</span><span class="o">/</span><span class="mf">2.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</div>
<div class="viewcode-block" id="pressure_broad_coefs"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.pressure_broad_coefs">[docs]</a><span class="k">def</span> <span class="nf">pressure_broad_coefs</span><span class="p">(</span><span class="n">Te</span><span class="p">):</span>
    
    <span class="n">te</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span>
          <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span>
          <span class="mi">800</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span>
          <span class="mi">6000</span><span class="p">,</span> <span class="mi">7000</span><span class="p">,</span> <span class="mi">8000</span><span class="p">,</span> <span class="mi">9000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">,</span> <span class="mi">30000</span><span class="p">]</span>
    <span class="n">te_indx</span> <span class="o">=</span> <span class="n">best_match_indx2</span><span class="p">(</span><span class="n">Te</span><span class="p">,</span> <span class="n">te</span><span class="p">)</span>
    
    <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">10.974098</span><span class="p">,</span>           
         <span class="o">-</span><span class="mf">10.669695</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">10.494541</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">10.370271</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">10.273172</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">10.191374</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">10.124309</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">10.064037</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">10.010153</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">9.9613006</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">9.6200366</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">9.4001678</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">9.2336349</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">9.0848840</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">8.9690170</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">8.8686695</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">8.7802238</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">8.7012421</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">8.6299908</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">8.2718376</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">8.0093937</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">7.8344941</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">7.7083367</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">7.6126791</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">7.5375720</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">7.4770500</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">7.4272885</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">7.3857095</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">7.1811733</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">7.1132522</span><span class="p">]</span>
    
    <span class="n">gammac</span> <span class="o">=</span> <span class="p">[</span><span class="mf">5.4821631</span><span class="p">,</span>
              <span class="mf">5.4354009</span><span class="p">,</span>
              <span class="mf">5.4071360</span><span class="p">,</span>
              <span class="mf">5.3861013</span><span class="p">,</span>
              <span class="mf">5.3689105</span><span class="p">,</span>
              <span class="mf">5.3535398</span><span class="p">,</span>
              <span class="mf">5.3409679</span><span class="p">,</span>
              <span class="mf">5.3290318</span><span class="p">,</span>
              <span class="mf">5.3180304</span><span class="p">,</span>
              <span class="mf">5.3077770</span><span class="p">,</span>
              <span class="mf">5.2283700</span><span class="p">,</span>
              <span class="mf">5.1700702</span><span class="p">,</span>
              <span class="mf">5.1224893</span><span class="p">,</span>
              <span class="mf">5.0770049</span><span class="p">,</span>
              <span class="mf">5.0408369</span><span class="p">,</span>
              <span class="mf">5.0086342</span><span class="p">,</span>
              <span class="mf">4.9796105</span><span class="p">,</span>
              <span class="mf">4.9532071</span><span class="p">,</span>
              <span class="mf">4.9290080</span><span class="p">,</span>
              <span class="mf">4.8063682</span><span class="p">,</span>
              <span class="mf">4.7057576</span><span class="p">,</span>
              <span class="mf">4.6356118</span><span class="p">,</span>
              <span class="mf">4.5831746</span><span class="p">,</span>
              <span class="mf">4.5421547</span><span class="p">,</span>
              <span class="mf">4.5090104</span><span class="p">,</span>
              <span class="mf">4.4815675</span><span class="p">,</span>
              <span class="mf">4.4584053</span><span class="p">,</span>
              <span class="mf">4.4385507</span><span class="p">,</span>
              <span class="mf">4.3290786</span><span class="p">,</span>
              <span class="mf">4.2814240</span><span class="p">]</span>
    
    <span class="n">a_func</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">te</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span>
                                  <span class="n">kind</span><span class="o">=</span><span class="s">&#39;linear&#39;</span><span class="p">,</span>
                                  <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                  <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    
    <span class="n">g_func</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">te</span><span class="p">,</span> <span class="n">gammac</span><span class="p">,</span>
                                  <span class="n">kind</span><span class="o">=</span><span class="s">&#39;linear&#39;</span><span class="p">,</span>
                                  <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                  <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">[</span><span class="n">a_func</span><span class="p">(</span><span class="n">Te</span><span class="p">),</span> <span class="n">g_func</span><span class="p">(</span><span class="n">Te</span><span class="p">)]</span>
    </div>
<div class="viewcode-block" id="radiation_broad"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.radiation_broad">[docs]</a><span class="k">def</span> <span class="nf">radiation_broad</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">Tr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Radiation induced broadening in Hz.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">return</span> <span class="mf">8e-17</span><span class="o">*</span><span class="n">W</span><span class="o">*</span><span class="n">Tr</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mf">5.8</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="radiation_broad_salgado"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.radiation_broad_salgado">[docs]</a><span class="k">def</span> <span class="nf">radiation_broad_salgado</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">Tr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Radiation induced broadening in Hz.</span>
<span class="sd">    This gives the FWHM of a Lorentzian line.</span>
<span class="sd">    Salgado et al. (2015)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">return</span> <span class="mf">6.096e-17</span><span class="o">*</span><span class="n">W</span><span class="o">*</span><span class="n">Tr</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mf">5.8</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="radiation_broad_salgado_general"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.radiation_broad_salgado_general">[docs]</a><span class="k">def</span> <span class="nf">radiation_broad_salgado_general</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">Tr</span><span class="p">,</span> <span class="n">nu0</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Radiation induced broadening in Hz.</span>
<span class="sd">    This gives the FWHM of a Lorentzian line.</span>
<span class="sd">    The expression is valid for power law like radiation fields.</span>
<span class="sd">    Salgado et al. (2015)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">cte</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">2.14e4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">6.578e15</span><span class="o">/</span><span class="n">nu0</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="n">k_B</span><span class="o">.</span><span class="n">cgs</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">nu0</span>
    <span class="n">dnexp</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">-</span> <span class="mf">2.</span>
    
    <span class="k">return</span> <span class="n">W</span><span class="o">*</span><span class="n">cte</span><span class="o">*</span><span class="n">Tr</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">alpha</span> <span class="o">-</span> <span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="n">dnexp</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">3.</span><span class="p">,</span> <span class="n">dnexp</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="remove_baseline"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.remove_baseline">[docs]</a><span class="k">def</span> <span class="nf">remove_baseline</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Divide tb by given a model</span>
<span class="sd">    and starting parameters p0.</span>
<span class="sd">    Returns: tb/model - 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Divide by linear baseline</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">make_params</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;Insuficient starting parameter values.&quot;</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">p0</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>

    <span class="n">fit</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="n">freq</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
    <span class="c">#best_fit = mod.eval(x=freq, amp=10, cen=6.2, wid=0.75)</span>
    <span class="n">tbcsub</span> <span class="o">=</span> <span class="n">tb</span><span class="o">/</span><span class="n">fit</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">freq</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="k">return</span> <span class="n">tbcsub</span>
</div>
<div class="viewcode-block" id="SavGol"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.SavGol">[docs]</a><span class="k">def</span> <span class="nf">SavGol</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c">#window_length, polyorder = args</span>
    <span class="n">sgf</span> <span class="o">=</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;window_length&#39;</span><span class="p">],</span> 
                        <span class="n">polyorder</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;polyorder&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">sgf</span>
</div>
<div class="viewcode-block" id="sigma2FWHM"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.sigma2FWHM">[docs]</a><span class="k">def</span> <span class="nf">sigma2FWHM</span><span class="p">(</span><span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts the sigma parameter of a Gaussian distribution</span>
<span class="sd">    to its FWHM.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">sigma</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="sigma2FWHM_err"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.sigma2FWHM_err">[docs]</a><span class="k">def</span> <span class="nf">sigma2FWHM_err</span><span class="p">(</span><span class="n">dsigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts the error on the sigma parameter of a Gaussian distribution</span>
<span class="sd">    to the error on the FWHM.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">dsigma</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="stack_irregular"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.stack_irregular">[docs]</a><span class="k">def</span> <span class="nf">stack_irregular</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stacks spectra by adding them together and </span>
<span class="sd">    then convolving with a window to reduce </span>
<span class="sd">    the noise.</span>
<span class="sd">    Available window functions:</span>
<span class="sd">    Gaussian, Savitzky-Golay and Wiener.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">vgrid</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tgrid</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ngrid</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c"># Loop over the spectra to stack</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="c"># Velocity in km/s</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="c"># Intensity in optical depth units</span>
        
        <span class="c"># Catch NaNs and invalid values:</span>
        <span class="n">mask_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span>
        <span class="n">mask_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">,</span> <span class="p">[</span><span class="n">mask_v</span><span class="p">,</span> <span class="n">mask_t</span><span class="p">]))</span>
        
        <span class="c"># Remove NaNs and invalid values</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">vel</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
        
        <span class="c"># Sort by velocity</span>
        <span class="n">vel</span><span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">tau</span><span class="p">))))</span>
        
        <span class="c"># Append</span>
        <span class="n">vgrid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vel</span><span class="p">)</span>
        <span class="n">tgrid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        
    <span class="c"># Flatten the stacked spectra</span>
    <span class="n">vgrid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">vgrid</span><span class="p">))</span>
    <span class="n">tgrid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">tgrid</span><span class="p">))</span>
    
     <span class="c"># Sort by velocity</span>
    <span class="n">vgrid</span><span class="p">,</span> <span class="n">tgrid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">vgrid</span><span class="p">,</span> <span class="n">tgrid</span><span class="p">))))</span>
    
    <span class="c"># Apply a window function to reduce noise</span>
    <span class="k">if</span> <span class="n">window</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;Using default Gaussian window.&#39;</span>
        <span class="n">stau</span> <span class="o">=</span> <span class="n">Gauss</span><span class="p">(</span><span class="n">tgrid</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;sigma&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s">&#39;order&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span>
    <span class="k">elif</span> <span class="n">window</span> <span class="o">==</span> <span class="s">&#39;Wiener&#39;</span><span class="p">:</span>
        <span class="n">stau</span> <span class="o">=</span> <span class="n">Wiener</span><span class="p">(</span><span class="n">tgrid</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">window</span> <span class="o">==</span> <span class="s">&#39;SavGol&#39;</span><span class="p">:</span>
        <span class="n">stau</span> <span class="o">=</span> <span class="n">SavGol</span><span class="p">(</span><span class="n">tgrid</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">window</span> <span class="o">==</span> <span class="s">&#39;Gauss&#39;</span><span class="p">:</span>
        <span class="n">stau</span> <span class="o">=</span> <span class="n">Gauss</span><span class="p">(</span><span class="n">tgrid</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
 
    <span class="k">return</span> <span class="n">vgrid</span><span class="p">,</span> <span class="n">tgrid</span><span class="p">,</span> <span class="n">stau</span>
        </div>
<div class="viewcode-block" id="stack_interpol"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.stack_interpol">[docs]</a><span class="k">def</span> <span class="nf">stack_interpol</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">rmsvec</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    
    <span class="n">vgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">dv</span><span class="p">)</span>
    <span class="n">tgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vgrid</span><span class="p">))</span>      <span class="c"># the temperatures</span>
    <span class="n">ngrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vgrid</span><span class="p">))</span>      <span class="c"># the number of tb points in every stacked channel</span>
    <span class="n">crms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">))</span>
    <span class="n">snr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">))</span>
    <span class="n">nspec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span> 
    <span class="n">nlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spectra</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Working on file: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">nlist</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="c"># velocity in km/s</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>  <span class="c"># optical depth</span>
        <span class="n">rms</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="c"># continuum rms</span>
        
        <span class="c"># Sort by velocity</span>
        <span class="n">vel</span><span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">tau</span><span class="p">))))</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vel</span><span class="p">)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        
        <span class="c"># Catch NaNs and invalid values:</span>
        <span class="n">mask_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span>
        <span class="n">mask_tb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">,</span> <span class="p">[</span><span class="n">mask_v</span><span class="p">,</span> <span class="n">mask_tb</span><span class="p">]))</span>
        
        <span class="c"># Interpolate non masked ranges indepently</span>
        <span class="n">mtau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
        <span class="n">mvel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">vel</span><span class="p">)</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">flatnotmasked_contiguous</span><span class="p">(</span><span class="n">mvel</span><span class="p">)</span>
        <span class="n">itb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vgrid</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">rng</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">valid</span><span class="p">):</span>
                <span class="c">#print &quot;slice {0}: {1}&quot;.format(i, rng)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="n">rng</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">interp_tb</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="n">rng</span><span class="p">],</span> <span class="n">tau</span><span class="p">[</span><span class="n">rng</span><span class="p">],</span>
                                                     <span class="n">kind</span><span class="o">=</span><span class="s">&#39;linear&#39;</span><span class="p">,</span>
                                                     <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                                     <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">itb</span> <span class="o">+=</span> <span class="n">interp_tb</span><span class="p">(</span><span class="n">vgrid</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">itb</span><span class="p">[</span><span class="n">best_match_indx</span><span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="n">rng</span><span class="p">],</span> <span class="n">vgrid</span><span class="p">,</span> <span class="n">dv</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">tau</span><span class="p">[</span><span class="n">rng</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">#print &quot;slice: {0}&quot;.format(valid)</span>
            <span class="n">interp_tb</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="n">tau</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span>
                                             <span class="n">kind</span><span class="o">=</span><span class="s">&#39;linear&#39;</span><span class="p">,</span>
                                             <span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                             <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">itb</span> <span class="o">+=</span> <span class="n">interp_tb</span><span class="p">(</span><span class="n">vgrid</span><span class="p">)</span>
        
        <span class="c"># Check the velocity coverage</span>
        <span class="n">chstack</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">ch</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">itb</span><span class="p">]</span>
        
        <span class="c"># Stack!</span>
        <span class="n">w</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">rms</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">ngrid</span><span class="p">)</span>
        <span class="c">#print w</span>
        <span class="n">ngrid</span> <span class="o">=</span> <span class="n">ngrid</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">chstack</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">tgrid</span> <span class="o">=</span> <span class="n">tgrid</span> <span class="o">+</span> <span class="n">itb</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">chstack</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
        
        <span class="n">sspec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">tgrid</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">)</span>
        <span class="n">svel</span> <span class="o">=</span> <span class="n">vgrid</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sspec</span><span class="p">)]</span>
        <span class="n">sspec</span> <span class="o">=</span> <span class="n">sspec</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sspec</span><span class="p">)]</span>
        <span class="n">vii</span> <span class="o">=</span> <span class="n">best_match_indx2</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">svel</span><span class="p">)</span>
        <span class="n">vfi</span> <span class="o">=</span> <span class="n">best_match_indx2</span><span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span> <span class="n">svel</span><span class="p">)</span>
        <span class="n">rmsl</span> <span class="o">=</span> <span class="n">get_rms</span><span class="p">(</span><span class="n">sspec</span><span class="p">[</span><span class="n">vii</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">vfi</span><span class="p">])</span>
        <span class="n">vii</span> <span class="o">=</span> <span class="n">best_match_indx2</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="n">svel</span><span class="p">)</span>
        <span class="n">vfi</span> <span class="o">=</span> <span class="n">best_match_indx2</span><span class="p">(</span><span class="n">vmax</span><span class="p">,</span> <span class="n">svel</span><span class="p">)</span>
        <span class="n">rmsr</span> <span class="o">=</span> <span class="n">get_rms</span><span class="p">(</span><span class="n">sspec</span><span class="p">[</span><span class="n">vii</span><span class="p">:</span><span class="n">vfi</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">crms</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rmsl</span><span class="p">,</span> <span class="n">rmsr</span><span class="p">)</span>
        <span class="n">snr</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">sspec</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">])</span><span class="o">/</span><span class="n">crms</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            
    <span class="c"># Divide by ngrid to preserve optical depth</span>
    <span class="n">tgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">tgrid</span><span class="p">,</span> <span class="n">ngrid</span><span class="p">)</span>
    
    <span class="c"># Compute the variation of the rms as we stack</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">crms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">PowerLawModel</span><span class="p">()</span>
        <span class="n">parms</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">crms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">exponent</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">crms</span><span class="p">,</span> <span class="n">parms</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">nspec</span><span class="p">)</span>
        <span class="n">best_fit</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">best_fit</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="c">#print nlist</span>
            <span class="k">print</span> <span class="n">fit</span><span class="o">.</span><span class="n">fit_report</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&quot;Lowest rms: {0} for # stacks: {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">crms</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">crms</span><span class="p">))</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
            <span class="c">#ax2 = ax1.twiny()</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nlist</span><span class="p">[::</span><span class="mi">1</span><span class="p">],</span> <span class="n">crms</span><span class="p">,</span> <span class="s">&#39;bo&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nlist</span><span class="p">[::</span><span class="mi">1</span><span class="p">],</span> <span class="n">best_fit</span><span class="p">,</span> <span class="s">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;best fit&#39;</span><span class="p">)</span>
            <span class="c">#ax1.plot(nlist[::1], mod.eval(x=nspec, amplitude=fit.params[&#39;amplitude&#39;].value, exponent=-0.5), </span>
                     <span class="c">#&#39;r:&#39;, label=r&#39;$1/\sqrt{\#}$&#39;)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nlist</span><span class="p">[::</span><span class="mi">1</span><span class="p">],</span> <span class="n">mod</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">nspec</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">crms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">exponent</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">),</span> 
                     <span class="s">&#39;r:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">r&#39;$1/\sqrt{\#}$&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;# stacks&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;Continuum rms&#39;</span><span class="p">)</span>
            <span class="c">#ax2.plot(nlist, np.ones(len(nlist))*min(crms), alpha=0)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">numpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="c">#ax2.cla()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nlist</span><span class="p">[::</span><span class="mi">1</span><span class="p">],</span> <span class="n">snr</span><span class="p">,</span> <span class="s">&#39;bo&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;# stacks&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;SNR&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">rmsvec</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">vgrid</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tgrid</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ngrid</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">nlist</span><span class="p">[::</span><span class="mi">1</span><span class="p">],</span> <span class="n">crms</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">vgrid</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tgrid</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ngrid</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="sum_line"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.sum_line">[docs]</a><span class="k">def</span> <span class="nf">sum_line</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">tau0</span><span class="p">,</span> <span class="n">dtau0</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">rms</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrate the spectrum near a given velocity v0.</span>
<span class="sd">    It stops when the channels are within a threshold</span>
<span class="sd">    from a reference level.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">results</span> <span class="o">=</span> <span class="n">sum_storage</span><span class="p">()</span>
    
    <span class="n">results</span><span class="p">[</span><span class="s">&#39;n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
    <span class="n">results</span><span class="p">[</span><span class="s">&#39;sb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sb</span>
    <span class="n">results</span><span class="p">[</span><span class="s">&#39;reffreq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>
    <span class="n">results</span><span class="p">[</span><span class="s">&#39;rms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rms</span>
    
    <span class="c"># The integrated optical depth starts at a value of 0</span>
    <span class="n">itau</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c"># Find where we start counting channels</span>
    <span class="n">dv</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">vel</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">v0_indx</span> <span class="o">=</span> <span class="n">best_match_indx2</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">vel</span><span class="p">)</span>
    <span class="c">#print &quot;v0_indx: {0}&quot;.format(v0_indx)</span>
    
    <span class="c"># Start adding to negative velocities</span>
    <span class="n">ch0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v0_indx</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">v0_indx</span><span class="o">-</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tau</span><span class="p">[</span><span class="n">v0_indx</span><span class="o">-</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">tau0</span> <span class="o">-</span> <span class="n">thr</span><span class="o">*</span><span class="n">dtau0</span><span class="p">:</span>
                <span class="n">itau</span> <span class="o">+=</span> <span class="n">tau</span><span class="p">[</span><span class="n">v0_indx</span><span class="o">-</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">dv</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ch0</span> <span class="o">=</span> <span class="n">v0_indx</span><span class="o">-</span><span class="n">i</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ch0</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">break</span>
    <span class="c"># Now to positive velocities</span>
    <span class="n">chf</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vel</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">v0_indx</span><span class="o">+</span><span class="n">i</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">vel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tau</span><span class="p">[</span><span class="n">v0_indx</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">tau0</span> <span class="o">-</span> <span class="n">thr</span><span class="o">*</span><span class="n">dtau0</span><span class="p">:</span>
                <span class="n">itau</span> <span class="o">+=</span> <span class="n">tau</span><span class="p">[</span><span class="n">v0_indx</span><span class="o">+</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">dv</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">chf</span> <span class="o">=</span> <span class="n">v0_indx</span><span class="o">+</span><span class="n">i</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chf</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">break</span>
        
    <span class="k">print</span> <span class="s">&quot;ch0: {0} chf: {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ch0</span><span class="p">,</span> <span class="n">chf</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">ch0</span> <span class="o">!=</span> <span class="n">chf</span><span class="p">:</span>
        <span class="n">results</span><span class="p">[</span><span class="s">&#39;tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tau</span><span class="p">[</span><span class="n">ch0</span><span class="p">:</span><span class="n">chf</span><span class="p">])</span>
        <span class="n">results</span><span class="p">[</span><span class="s">&#39;vp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vel</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tau</span> <span class="o">==</span> <span class="n">results</span><span class="p">[</span><span class="s">&#39;tau&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">results</span><span class="p">[</span><span class="s">&#39;dtau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtau0</span>
    
    <span class="c">#print &quot;Sum vp: {0}&quot;.format(results[&#39;vp&#39;])</span>
    <span class="n">results</span><span class="p">[</span><span class="s">&#39;dvp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dv</span>
    <span class="n">results</span><span class="p">[</span><span class="s">&#39;dv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="n">chf</span><span class="p">]</span> <span class="o">-</span> <span class="n">vel</span><span class="p">[</span><span class="n">ch0</span><span class="p">])</span>
    <span class="n">results</span><span class="p">[</span><span class="s">&#39;ddv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dv</span> <span class="c"># Bad assumption</span>
    <span class="n">results</span><span class="p">[</span><span class="s">&#39;itau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">itau</span>
    <span class="n">results</span><span class="p">[</span><span class="s">&#39;ditau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ch0</span> <span class="o">-</span> <span class="n">chf</span><span class="p">)</span><span class="o">*</span><span class="n">rms</span>
    <span class="n">results</span><span class="p">[</span><span class="s">&#39;ch0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch0</span>
    <span class="n">results</span><span class="p">[</span><span class="s">&#39;chf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chf</span>
    <span class="n">results</span><span class="p">[</span><span class="s">&#39;tau0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau0</span> <span class="o">-</span> <span class="n">thr</span><span class="o">*</span><span class="n">dtau0</span>
        
    <span class="k">return</span> <span class="n">results</span>
</div>
<div class="viewcode-block" id="sum_storage"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.sum_storage">[docs]</a><span class="k">def</span> <span class="nf">sum_storage</span><span class="p">():</span>
    <span class="n">blankval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">99</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(((</span><span class="s">&#39;sb&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>      <span class="c">#0 Sub Band number</span>
                                       <span class="p">(</span><span class="s">&#39;n&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>       <span class="c">#1 Principal quantum number</span>
                                       <span class="p">(</span><span class="s">&#39;reffreq&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span> <span class="c">#2 Reference frequency</span>
                                       <span class="p">(</span><span class="s">&#39;tau&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>     <span class="c">#3 Peak optical depth</span>
                                       <span class="p">(</span><span class="s">&#39;vp&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>      <span class="c">#4 Velocity of peak optical depth</span>
                                       <span class="p">(</span><span class="s">&#39;dv&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>      <span class="c">#5 Line width</span>
                                       <span class="p">(</span><span class="s">&#39;itau&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>    <span class="c">#6 Integrated optical depth</span>
                                       <span class="p">(</span><span class="s">&#39;tau0&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>    <span class="c">#7 Optical depth cutoff</span>
                                       <span class="p">(</span><span class="s">&#39;dtau&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>    <span class="c">#8 Peak optical depth error</span>
                                       <span class="p">(</span><span class="s">&#39;dvp&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>     <span class="c">#9 Velocity of peak optical depth error</span>
                                       <span class="p">(</span><span class="s">&#39;ddv&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>     <span class="c">#10 Line width error</span>
                                       <span class="p">(</span><span class="s">&#39;ditau&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>   <span class="c">#11 Integrated optical depth error</span>
                                       <span class="p">(</span><span class="s">&#39;dtau0&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>   <span class="c">#12 Optical depth offset error</span>
                                       <span class="p">(</span><span class="s">&#39;ch0&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>     <span class="c">#13</span>
                                       <span class="p">(</span><span class="s">&#39;chf&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">),</span>     <span class="c">#14</span>
                                       <span class="p">(</span><span class="s">&#39;rms&#39;</span><span class="p">,</span><span class="n">blankval</span><span class="p">)))</span>    <span class="c">#15 Continuum rms</span>
                                       
    <span class="k">return</span> <span class="n">results</span>
</div>
<div class="viewcode-block" id="tryint"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.tryint">[docs]</a><span class="k">def</span> <span class="nf">tryint</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span>
</div>
<div class="viewcode-block" id="vel2freq"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.vel2freq">[docs]</a><span class="k">def</span> <span class="nf">vel2freq</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="n">vel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a velocity axis</span>
<span class="sd">    to a frequency axis given</span>
<span class="sd">    a central frequency.</span>
<span class="sd">    Uses the radio definition.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">f0</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">vel</span><span class="o">/</span><span class="n">c</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="voigt"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.voigt">[docs]</a><span class="k">def</span> <span class="nf">voigt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="c"># The Voigt function is also the real part of </span>
    <span class="c"># w(z) = exp(-z^2) erfc(iz), the complex probability function,</span>
    <span class="c"># which is also known as the Faddeeva function. Scipy has </span>
    <span class="c"># implemented this function under the name wofz()</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1j</span><span class="o">*</span><span class="n">y</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">wofz</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>

    <span class="k">return</span> <span class="n">I</span>
</div>
<div class="viewcode-block" id="Voigt"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.Voigt">[docs]</a><span class="k">def</span> <span class="nf">Voigt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Voigt line shape in terms of its physical parameters</span>
<span class="sd">    x: independent variable</span>
<span class="sd">    sigma: HWHM of the Gaussian</span>
<span class="sd">    gamma: HWHM of the Lorentzian</span>
<span class="sd">    center: the line center</span>
<span class="sd">    amplitude: the line area</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ln2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ln2</span><span class="p">)</span>
    <span class="n">rx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">f</span>
    <span class="n">ry</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">/</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">f</span>

    <span class="n">V</span> <span class="o">=</span> <span class="n">amplitude</span><span class="o">*</span><span class="n">f</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">*</span> <span class="n">voigt</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">V</span>
</div>
<div class="viewcode-block" id="voigt_area"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.voigt_area">[docs]</a><span class="k">def</span> <span class="nf">voigt_area</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the area under a Voigt profile.</span>
<span class="sd">    This approximation has an error of less than 0.5%</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">l</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">gamma</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">sigma</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">g</span><span class="o">/</span><span class="p">(</span><span class="n">g</span><span class="o">+</span><span class="n">l</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mf">1.572</span> <span class="o">+</span> <span class="mf">0.05288</span><span class="o">*</span><span class="n">k</span> <span class="o">+</span> <span class="o">-</span><span class="mf">1.323</span><span class="o">*</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.7658</span><span class="o">*</span><span class="n">k</span><span class="o">**</span><span class="mi">3</span>
    
    <span class="k">return</span> <span class="n">c</span><span class="o">*</span><span class="n">amp</span><span class="o">*</span><span class="n">fwhm</span>
</div>
<div class="viewcode-block" id="voigt_area_err"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.voigt_area_err">[docs]</a><span class="k">def</span> <span class="nf">voigt_area_err</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">damp</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">dfwhm</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the error of the area under a Voigt profile.</span>
<span class="sd">    Assumes that the parameter c has an error of 0.5%.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">l</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">gamma</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">sigma</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">g</span><span class="o">/</span><span class="p">(</span><span class="n">g</span><span class="o">+</span><span class="n">l</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mf">1.572</span> <span class="o">+</span> <span class="mf">0.05288</span><span class="o">*</span><span class="n">k</span> <span class="o">+</span> <span class="o">-</span><span class="mf">1.323</span><span class="o">*</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.7658</span><span class="o">*</span><span class="n">k</span><span class="o">**</span><span class="mi">3</span>
    
    <span class="n">err_a</span> <span class="o">=</span> <span class="n">area</span><span class="o">/</span><span class="n">amp</span><span class="o">*</span><span class="n">damp</span>
    <span class="n">err_f</span> <span class="o">=</span> <span class="n">area</span><span class="o">/</span><span class="n">fwhm</span><span class="o">*</span><span class="n">dfwhm</span>
    <span class="n">err_c</span> <span class="o">=</span> <span class="n">area</span><span class="o">/</span><span class="n">c</span><span class="o">*</span><span class="mf">0.5</span><span class="o">/</span><span class="mf">100.0</span>
    
    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">err_a</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">err_f</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">err_c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">err</span>
</div>
<div class="viewcode-block" id="voigt_peak"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.voigt_peak">[docs]</a><span class="k">def</span> <span class="nf">voigt_peak</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">alphaD</span><span class="p">,</span> <span class="n">alphaL</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gives the peak of a Voigt profile given</span>
<span class="sd">    its Area and the HWHM of the Gaussian and</span>
<span class="sd">    Lorentz profiles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">y</span> <span class="o">=</span> <span class="n">alphaL</span><span class="o">/</span><span class="n">alphaD</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">1j</span><span class="o">*</span><span class="n">y</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">wofz</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
    
    <span class="n">peak</span> <span class="o">=</span> <span class="n">A</span><span class="o">/</span><span class="n">alphaD</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">K</span>
    
    <span class="k">return</span> <span class="n">peak</span>
</div>
<div class="viewcode-block" id="voigt_peak2area"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.voigt_peak2area">[docs]</a><span class="k">def</span> <span class="nf">voigt_peak2area</span><span class="p">(</span><span class="n">peak</span><span class="p">,</span> <span class="n">alphaD</span><span class="p">,</span> <span class="n">alphaL</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts the peak of a Voigt profile into the area under the profile</span>
<span class="sd">    given the HWHM of the profile.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">y</span> <span class="o">=</span> <span class="n">alphaL</span><span class="o">/</span><span class="n">alphaD</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">1j</span><span class="o">*</span><span class="n">y</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">wofz</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
    
    <span class="n">A</span> <span class="o">=</span> <span class="n">peak</span><span class="o">*</span><span class="n">alphaD</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">K</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">A</span>
    
</div>
<div class="viewcode-block" id="voigt_peak_err"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.voigt_peak_err">[docs]</a><span class="k">def</span> <span class="nf">voigt_peak_err</span><span class="p">(</span><span class="n">peak</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">dA</span><span class="p">,</span> <span class="n">alphaD</span><span class="p">,</span> <span class="n">dalphaD</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gives the error on the peak of</span>
<span class="sd">    the Voigt profile.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">dpeak</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dalphaD</span><span class="o">/</span><span class="n">alphaD</span> <span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dA</span><span class="o">/</span><span class="n">A</span> <span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">dpeak</span>
</div>
<div class="viewcode-block" id="Wiener"><a class="viewcode-back" href="../../includeme.html#crrlpy.crrls.Wiener">[docs]</a><span class="k">def</span> <span class="nf">Wiener</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c">#size, noise = args</span>
    <span class="n">wi</span> <span class="o">=</span> <span class="n">wiener</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">mysize</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;mysize&#39;</span><span class="p">],</span> <span class="n">noise</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;noise&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">wi</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">CRRLpy 0.1 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Pedro Salas.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>